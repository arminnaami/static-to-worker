{"title":"巴哈姆特 imgur 上傳器","slug":"baha-imgur-upload","date":"2017-12-30T08:09:33.000Z","updated":"2019-08-16T11:14:47.543Z","comments":true,"path":"api/articles/baha-imgur-upload.json","excerpt":"這是一個簡單的巴哈姆特 userscript<br>可以在上傳圖片的對話框中增加上傳到 imgur 的功能發在場外的文章","covers":["usage.gif","usage2.gif"],"content":"<p>這是一個簡單的巴哈姆特 userscript<br>可以在<strong>上傳圖片</strong>的對話框中增加上傳到 imgur 的功能</p>\n<p><a href=\"https://forum.gamer.com.tw/C.php?bsn=60076&snA=4338034\" target=\"_blank\" rel=\"noopener\">發在場外的文章</a></p>\n<a id=\"more\"></a>\n\n<p>腳本網址: <a href=\"https://greasyfork.org/zh-TW/scripts/36735-baha-imgur-upload\" target=\"_blank\" rel=\"noopener\">https://greasyfork.org/zh-TW/scripts/36735-baha-imgur-upload</a></p>\n<h1 id=\"使用教學\"><a href=\"#使用教學\" class=\"headerlink\" title=\"使用教學\"></a>使用教學</h1><p>其實就下面兩張 gif 圖片而已不過在第一次使用下面任何一個功能時會彈出一個視窗要求登入 imgur 的帳號並驗證</p>\n<h2 id=\"從電腦選取圖片上傳\"><a href=\"#從電腦選取圖片上傳\" class=\"headerlink\" title=\"從電腦選取圖片上傳\"></a>從電腦選取圖片上傳</h2><p><img src=\"usage.gif\" alt=\"basic usage\"></p>\n<h2 id=\"把外部網址轉換成-imgur-網址\"><a href=\"#把外部網址轉換成-imgur-網址\" class=\"headerlink\" title=\"把外部網址轉換成 imgur 網址\"></a>把外部網址轉換成 imgur 網址</h2><p><img src=\"usage2.gif\" alt=\"basic usage2\"></p>\n<h1 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h1><p>基本上這個腳本的實作原理就是使用者登入後取得<code>access_token</code>並將它保存下來然後上傳時用這個<code>access_token</code>去向 api 伺服器上傳圖片完整的 code 可以到 <a href=\"https://greasyfork.org/zh-TW/scripts/36735-baha-imgur-upload/code\" target=\"_blank\" rel=\"noopener\">greasyfork</a> 上看</p>\n<blockquote>\n<p>下面的 code 是 0.5 版的</p>\n</blockquote>\n<h2 id=\"取得-access-token\"><a href=\"#取得-access-token\" class=\"headerlink\" title=\"取得 access_token\"></a>取得 access_token</h2><p>因為 imgur 在註冊 Application 時要提供一個 callback 網址所以我是直接把它放在 <a href=\"/bahamut-imgur-upload.html\">bahamut-imgur-upload.html</a> 頁面上然後用 javascript 把<code>access_token</code>從網址中取出</p>\n<p>網址格式:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://blog.maple3142.net/bahamut-imgur-upload.html#access_token=$&#123;access_token&#125;&amp;expires_in=aaa&amp;token_type=bbb&amp;refresh_token=ccc&amp;account_username=ddd&amp;account_id=eee</span><br></pre></td></tr></table></figure>\n\n<p>這裡面重要的只有<code>access_token</code>欄位，不過特別的是 query string 不知道為什麼會被放在 hashbang 之後所以就用 regex 把<code>access_token</code>給取出來，然後存在腳本的儲存空間中</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// @match        https://blog.maple3142.net/bahamut-imgur-upload.html</span></span><br><span class=\"line\"><span class=\"comment\">// blah blah blah....</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (location.hostname === <span class=\"string\">'blog.maple3142.net'</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> access_token = <span class=\"regexp\">/access_token=(.*?)&amp;/</span>.exec(location.hash)[<span class=\"number\">1</span>]</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (access_token) &#123;</span><br><span class=\"line\">    GM_setValue(<span class=\"string\">'access_token'</span>, access_token)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"helpers\"><a href=\"#helpers\" class=\"headerlink\" title=\"helpers\"></a>helpers</h2><h3 id=\"上傳\"><a href=\"#上傳\" class=\"headerlink\" title=\"上傳\"></a>上傳</h3><p>上傳的部分直接寫成一個函數來用，回傳一個<code>Promise</code><br>data 部分只放一個 image 是因為 imgur 能自己判斷 image 是 base64 還是網址而 catch 的部分先寫好是因為外面的錯誤處理都是 alert 然後把上傳視窗關閉</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">upload</span>(<span class=\"params\">image</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> $.ajax(&#123;</span><br><span class=\"line\">    type: <span class=\"string\">'POST'</span>,</span><br><span class=\"line\">    url: <span class=\"string\">'https://api.imgur.com/3/image'</span>,</span><br><span class=\"line\">    data: &#123; image &#125;,</span><br><span class=\"line\">    headers: &#123;</span><br><span class=\"line\">      Authorization: <span class=\"string\">`Bearer <span class=\"subst\">$&#123;GM_getValue(<span class=\"string\">'access_token'</span>)&#125;</span>`</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    dataType: <span class=\"string\">'json'</span></span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"params\">e</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.error(e)</span><br><span class=\"line\">    alert(<span class=\"string\">'上傳失敗'</span>)</span><br><span class=\"line\">    egg.lightbox.close()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h3><p>這邊是另外 3 個簡單的輔助函數</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">chk_isAuthorized</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//檢查有沒有access_token</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> GM_getValue(<span class=\"string\">'access_token'</span>, <span class=\"literal\">null</span>) !== <span class=\"literal\">null</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">login</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//觸發登入視窗</span></span><br><span class=\"line\">  <span class=\"built_in\">window</span>.open(</span><br><span class=\"line\">    <span class=\"string\">'https://api.imgur.com/oauth2/authorize?client_id=41e93183c27ec0e&amp;response_type=token'</span>,</span><br><span class=\"line\">    <span class=\"string\">'oauth'</span>,</span><br><span class=\"line\">    <span class=\"string\">'height=700,width=700'</span></span><br><span class=\"line\">  )</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">readbase64</span>(<span class=\"params\">file</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//讀取檔案成為base64</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">res, rej</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> reader = <span class=\"keyword\">new</span> FileReader()</span><br><span class=\"line\">    reader.onload = <span class=\"function\"><span class=\"params\">e</span> =&gt;</span> res(e.target.result)</span><br><span class=\"line\">    reader.onerror = <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> rej(err)</span><br><span class=\"line\">    reader.readAsDataURL(file)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"UI-和主要邏輯\"><a href=\"#UI-和主要邏輯\" class=\"headerlink\" title=\"UI 和主要邏輯\"></a>UI 和主要邏輯</h2><p>UI 部分稍微麻煩了一些，因為上傳框並不是本來就存在的，是用 js 生成出來的所以只好用<code>MutationObserver</code>來監聽 DOM 的變化</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> observer = <span class=\"keyword\">new</span> MutationObserver(<span class=\"function\"><span class=\"params\">_</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> $origUpl = $(<span class=\"string\">'#bhImgModeUpload'</span>) <span class=\"comment\">//上傳圖片框</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ($origUpl.css(<span class=\"string\">'display'</span>) === <span class=\"string\">'block'</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//如果上傳圖片框存在</span></span><br><span class=\"line\">    <span class=\"comment\">//先跳過，這裡會新增一個 div#bahaimgur 元素</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    $(<span class=\"string\">'#bahaimgur'</span>).remove() <span class=\"comment\">//當不存在的時候就把 div#bahaimgur 移除掉</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> $origUrlinput = $(<span class=\"string\">'#bhImgModeInsertUrl'</span>) <span class=\"comment\">//插入圖片網址的輸入框，這部分和上面很像</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ($origUrlinput.css(<span class=\"string\">'display'</span>) === <span class=\"string\">'block'</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//先跳過，這裡會新增一個 div#bahaimgur_cvt 元素</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    $(<span class=\"string\">'#bahaimgur_cvt'</span>).remove()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">observer.observe(<span class=\"built_in\">document</span>.body, &#123; <span class=\"attr\">attributes</span>: <span class=\"literal\">true</span>, <span class=\"attr\">childList</span>: <span class=\"literal\">true</span>, <span class=\"attr\">characterData</span>: <span class=\"literal\">true</span>, <span class=\"attr\">subtree</span>: <span class=\"literal\">true</span> &#125;) <span class=\"comment\">//在 &lt;body&gt; 上監聽</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"bahaimgur\"><a href=\"#bahaimgur\" class=\"headerlink\" title=\"#bahaimgur\"></a>#bahaimgur</h3><p>這是上面 observer 裡面第一個 if 的內容</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($(<span class=\"string\">'#imgurupl'</span>).length) <span class=\"keyword\">return</span> <span class=\"comment\">//如果已經有了就不要再新增了，否則會無限迴圈</span></span><br><span class=\"line\">$origUpl.after(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">&lt;div id=\"bahaimgur\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">  &lt;input type=\"file\" accept=\"image/*\" id=\"imgurupl\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">  &lt;button id=\"imguruplbtn\"&gt;上傳imgur&lt;/button&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">`</span>) <span class=\"comment\">//插入元素</span></span><br><span class=\"line\">$(<span class=\"string\">'#imguruplbtn'</span>).on(<span class=\"string\">'click'</span>, e =&gt; &#123;</span><br><span class=\"line\">  e.preventDefault()</span><br><span class=\"line\">  e.stopPropagation()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!chk_isAuthorized()) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//如果還沒有登入就要求登入</span></span><br><span class=\"line\">    login()</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> file = $(<span class=\"string\">'#imgurupl'</span>)[<span class=\"number\">0</span>].files[<span class=\"number\">0</span>]</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!file) <span class=\"keyword\">return</span> <span class=\"comment\">//no file</span></span><br><span class=\"line\"></span><br><span class=\"line\">  readbase64(file)</span><br><span class=\"line\">    .then(<span class=\"function\"><span class=\"params\">image</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">//讀取檔案成 base64格式</span></span><br><span class=\"line\">      $(<span class=\"string\">'#bahaimgur'</span>).hide(),</span><br><span class=\"line\">        $(<span class=\"string\">'#bhImgMsg'</span>)</span><br><span class=\"line\">          .html(<span class=\"string\">'圖片上傳中, 請稍候...'</span>)</span><br><span class=\"line\">          .show(),</span><br><span class=\"line\">        $(<span class=\"string\">'#bhImgModeUpload'</span>).hide()</span><br><span class=\"line\">      <span class=\"keyword\">return</span> upload(image.split(<span class=\"string\">'base64,'</span>)[<span class=\"number\">1</span>]) <span class=\"comment\">//這邊要做split是因為readbase64給的字串是dataurl的形式，可是imgur api要的是純base64字串</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    .then(<span class=\"function\"><span class=\"params\">r</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!r.success) &#123;</span><br><span class=\"line\">        alert(<span class=\"string\">'上傳失敗'</span>)</span><br><span class=\"line\">        egg.lightbox.close()</span><br><span class=\"line\">        <span class=\"keyword\">return</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"comment\">//r.data.link 是照片的網址</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (unsafeWindow.bahaRte != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//如果有所見即所得編輯器</span></span><br><span class=\"line\">        bahaRte.toolbar.insertUploadedImage(r.data.link)</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ($(<span class=\"string\">'#balaTextId'</span>).length) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//如果是公會/叭啦叭啦頁面的回覆框旁邊的上傳圖片</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> id = $(<span class=\"string\">'#balaTextId'</span>).html() <span class=\"comment\">//取得輸入框的id</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> $tx = $(<span class=\"string\">'#'</span> + id) <span class=\"comment\">//輸入框</span></span><br><span class=\"line\">        $tx.val($tx.val() + r.data.link) <span class=\"comment\">//append</span></span><br><span class=\"line\">        egg.lightbox.close()</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ($(<span class=\"string\">'#msgtalk'</span>).length) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//如果是公會/叭啦叭啦頁面的新增欄位 (這一定要放在上面的if後面)</span></span><br><span class=\"line\">        egg.lightbox.close()</span><br><span class=\"line\">        <span class=\"keyword\">const</span> $msgtalk = $(<span class=\"string\">'#msgtalk'</span>)</span><br><span class=\"line\">        $msgtalk.val($msgtalk.val() + r.data.link) <span class=\"comment\">//append</span></span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//其他種類 ex:新版哈拉區文章底部的簡易編輯器</span></span><br><span class=\"line\">        prompt(<span class=\"string\">'暫時還不支援這種編輯器，不過可以複製下方的網址來貼上'</span>, r.data.link)</span><br><span class=\"line\">        $(<span class=\"string\">'#bhImgMsg'</span>).hide()</span><br><span class=\"line\">        $(<span class=\"string\">'#bhImgModeUpload'</span>).show()</span><br><span class=\"line\">        $(<span class=\"string\">'#bahaimgur'</span>).show()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"bahaimgur-cvt\"><a href=\"#bahaimgur-cvt\" class=\"headerlink\" title=\"#bahaimgur_cvt\"></a>#bahaimgur_cvt</h3><p>這和上面的也有點類似，不過更簡單一些</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($(<span class=\"string\">'#bahaimgur_cvt'</span>).length) <span class=\"keyword\">return</span></span><br><span class=\"line\">$(<span class=\"string\">'#bhImgImageUrl'</span>).after(<span class=\"string\">`&lt;button id=\"bahaimgur_cvt\"&gt;轉換成imgur網址&lt;/button&gt;`</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">$(<span class=\"string\">'#bahaimgur_cvt'</span>).on(<span class=\"string\">'click'</span>, e =&gt; &#123;</span><br><span class=\"line\">  e.preventDefault()</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!chk_isAuthorized()) &#123;</span><br><span class=\"line\">    login()</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> url = $(<span class=\"string\">'#bhImgImageUrl'</span>).val() <span class=\"comment\">//取得輸入框內容</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!url) &#123;</span><br><span class=\"line\">    alert(<span class=\"string\">'請輸入網址'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  $(<span class=\"string\">'#bhImgMsg'</span>)</span><br><span class=\"line\">    .html(<span class=\"string\">'圖片上傳中, 請稍候...'</span>)</span><br><span class=\"line\">    .show()</span><br><span class=\"line\">  upload(url).then(<span class=\"function\"><span class=\"params\">r</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//直接把原本的 url 作為 image 傳給 imgur api</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!r.success) &#123;</span><br><span class=\"line\">      alert(<span class=\"string\">'上傳失敗'</span>)</span><br><span class=\"line\">      egg.lightbox.close()</span><br><span class=\"line\">      <span class=\"keyword\">return</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $(<span class=\"string\">'#bhImgImageUrl'</span>).val(r.data.link) <span class=\"comment\">//把原本的輸入框網址換成 imgur 回傳的 url</span></span><br><span class=\"line\">    $(<span class=\"string\">'#bhImgMsg'</span>).hide()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n","more":"<p>腳本網址: <a href=\"https://greasyfork.org/zh-TW/scripts/36735-baha-imgur-upload\" target=\"_blank\" rel=\"noopener\">https://greasyfork.org/zh-TW/scripts/36735-baha-imgur-upload</a></p>\n<h1 id=\"使用教學\"><a href=\"#使用教學\" class=\"headerlink\" title=\"使用教學\"></a>使用教學</h1><p>其實就下面兩張 gif 圖片而已不過在第一次使用下面任何一個功能時會彈出一個視窗要求登入 imgur 的帳號並驗證</p>\n<h2 id=\"從電腦選取圖片上傳\"><a href=\"#從電腦選取圖片上傳\" class=\"headerlink\" title=\"從電腦選取圖片上傳\"></a>從電腦選取圖片上傳</h2><p><img src=\"usage.gif\" alt=\"basic usage\"></p>\n<h2 id=\"把外部網址轉換成-imgur-網址\"><a href=\"#把外部網址轉換成-imgur-網址\" class=\"headerlink\" title=\"把外部網址轉換成 imgur 網址\"></a>把外部網址轉換成 imgur 網址</h2><p><img src=\"usage2.gif\" alt=\"basic usage2\"></p>\n<h1 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h1><p>基本上這個腳本的實作原理就是使用者登入後取得<code>access_token</code>並將它保存下來然後上傳時用這個<code>access_token</code>去向 api 伺服器上傳圖片完整的 code 可以到 <a href=\"https://greasyfork.org/zh-TW/scripts/36735-baha-imgur-upload/code\" target=\"_blank\" rel=\"noopener\">greasyfork</a> 上看</p>\n<blockquote>\n<p>下面的 code 是 0.5 版的</p>\n</blockquote>\n<h2 id=\"取得-access-token\"><a href=\"#取得-access-token\" class=\"headerlink\" title=\"取得 access_token\"></a>取得 access_token</h2><p>因為 imgur 在註冊 Application 時要提供一個 callback 網址所以我是直接把它放在 <a href=\"/bahamut-imgur-upload.html\">bahamut-imgur-upload.html</a> 頁面上然後用 javascript 把<code>access_token</code>從網址中取出</p>\n<p>網址格式:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://blog.maple3142.net/bahamut-imgur-upload.html#access_token=$&#123;access_token&#125;&amp;expires_in=aaa&amp;token_type=bbb&amp;refresh_token=ccc&amp;account_username=ddd&amp;account_id=eee</span><br></pre></td></tr></table></figure>\n\n<p>這裡面重要的只有<code>access_token</code>欄位，不過特別的是 query string 不知道為什麼會被放在 hashbang 之後所以就用 regex 把<code>access_token</code>給取出來，然後存在腳本的儲存空間中</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// @match        https://blog.maple3142.net/bahamut-imgur-upload.html</span></span><br><span class=\"line\"><span class=\"comment\">// blah blah blah....</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (location.hostname === <span class=\"string\">'blog.maple3142.net'</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> access_token = <span class=\"regexp\">/access_token=(.*?)&amp;/</span>.exec(location.hash)[<span class=\"number\">1</span>]</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (access_token) &#123;</span><br><span class=\"line\">    GM_setValue(<span class=\"string\">'access_token'</span>, access_token)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"helpers\"><a href=\"#helpers\" class=\"headerlink\" title=\"helpers\"></a>helpers</h2><h3 id=\"上傳\"><a href=\"#上傳\" class=\"headerlink\" title=\"上傳\"></a>上傳</h3><p>上傳的部分直接寫成一個函數來用，回傳一個<code>Promise</code><br>data 部分只放一個 image 是因為 imgur 能自己判斷 image 是 base64 還是網址而 catch 的部分先寫好是因為外面的錯誤處理都是 alert 然後把上傳視窗關閉</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">upload</span>(<span class=\"params\">image</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> $.ajax(&#123;</span><br><span class=\"line\">    type: <span class=\"string\">'POST'</span>,</span><br><span class=\"line\">    url: <span class=\"string\">'https://api.imgur.com/3/image'</span>,</span><br><span class=\"line\">    data: &#123; image &#125;,</span><br><span class=\"line\">    headers: &#123;</span><br><span class=\"line\">      Authorization: <span class=\"string\">`Bearer <span class=\"subst\">$&#123;GM_getValue(<span class=\"string\">'access_token'</span>)&#125;</span>`</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    dataType: <span class=\"string\">'json'</span></span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"params\">e</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.error(e)</span><br><span class=\"line\">    alert(<span class=\"string\">'上傳失敗'</span>)</span><br><span class=\"line\">    egg.lightbox.close()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h3><p>這邊是另外 3 個簡單的輔助函數</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">chk_isAuthorized</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//檢查有沒有access_token</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> GM_getValue(<span class=\"string\">'access_token'</span>, <span class=\"literal\">null</span>) !== <span class=\"literal\">null</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">login</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//觸發登入視窗</span></span><br><span class=\"line\">  <span class=\"built_in\">window</span>.open(</span><br><span class=\"line\">    <span class=\"string\">'https://api.imgur.com/oauth2/authorize?client_id=41e93183c27ec0e&amp;response_type=token'</span>,</span><br><span class=\"line\">    <span class=\"string\">'oauth'</span>,</span><br><span class=\"line\">    <span class=\"string\">'height=700,width=700'</span></span><br><span class=\"line\">  )</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">readbase64</span>(<span class=\"params\">file</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//讀取檔案成為base64</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">res, rej</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> reader = <span class=\"keyword\">new</span> FileReader()</span><br><span class=\"line\">    reader.onload = <span class=\"function\"><span class=\"params\">e</span> =&gt;</span> res(e.target.result)</span><br><span class=\"line\">    reader.onerror = <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> rej(err)</span><br><span class=\"line\">    reader.readAsDataURL(file)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"UI-和主要邏輯\"><a href=\"#UI-和主要邏輯\" class=\"headerlink\" title=\"UI 和主要邏輯\"></a>UI 和主要邏輯</h2><p>UI 部分稍微麻煩了一些，因為上傳框並不是本來就存在的，是用 js 生成出來的所以只好用<code>MutationObserver</code>來監聽 DOM 的變化</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> observer = <span class=\"keyword\">new</span> MutationObserver(<span class=\"function\"><span class=\"params\">_</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> $origUpl = $(<span class=\"string\">'#bhImgModeUpload'</span>) <span class=\"comment\">//上傳圖片框</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ($origUpl.css(<span class=\"string\">'display'</span>) === <span class=\"string\">'block'</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//如果上傳圖片框存在</span></span><br><span class=\"line\">    <span class=\"comment\">//先跳過，這裡會新增一個 div#bahaimgur 元素</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    $(<span class=\"string\">'#bahaimgur'</span>).remove() <span class=\"comment\">//當不存在的時候就把 div#bahaimgur 移除掉</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> $origUrlinput = $(<span class=\"string\">'#bhImgModeInsertUrl'</span>) <span class=\"comment\">//插入圖片網址的輸入框，這部分和上面很像</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ($origUrlinput.css(<span class=\"string\">'display'</span>) === <span class=\"string\">'block'</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//先跳過，這裡會新增一個 div#bahaimgur_cvt 元素</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    $(<span class=\"string\">'#bahaimgur_cvt'</span>).remove()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">observer.observe(<span class=\"built_in\">document</span>.body, &#123; <span class=\"attr\">attributes</span>: <span class=\"literal\">true</span>, <span class=\"attr\">childList</span>: <span class=\"literal\">true</span>, <span class=\"attr\">characterData</span>: <span class=\"literal\">true</span>, <span class=\"attr\">subtree</span>: <span class=\"literal\">true</span> &#125;) <span class=\"comment\">//在 &lt;body&gt; 上監聽</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"bahaimgur\"><a href=\"#bahaimgur\" class=\"headerlink\" title=\"#bahaimgur\"></a>#bahaimgur</h3><p>這是上面 observer 裡面第一個 if 的內容</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($(<span class=\"string\">'#imgurupl'</span>).length) <span class=\"keyword\">return</span> <span class=\"comment\">//如果已經有了就不要再新增了，否則會無限迴圈</span></span><br><span class=\"line\">$origUpl.after(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">&lt;div id=\"bahaimgur\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">  &lt;input type=\"file\" accept=\"image/*\" id=\"imgurupl\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">  &lt;button id=\"imguruplbtn\"&gt;上傳imgur&lt;/button&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">`</span>) <span class=\"comment\">//插入元素</span></span><br><span class=\"line\">$(<span class=\"string\">'#imguruplbtn'</span>).on(<span class=\"string\">'click'</span>, e =&gt; &#123;</span><br><span class=\"line\">  e.preventDefault()</span><br><span class=\"line\">  e.stopPropagation()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!chk_isAuthorized()) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//如果還沒有登入就要求登入</span></span><br><span class=\"line\">    login()</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> file = $(<span class=\"string\">'#imgurupl'</span>)[<span class=\"number\">0</span>].files[<span class=\"number\">0</span>]</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!file) <span class=\"keyword\">return</span> <span class=\"comment\">//no file</span></span><br><span class=\"line\"></span><br><span class=\"line\">  readbase64(file)</span><br><span class=\"line\">    .then(<span class=\"function\"><span class=\"params\">image</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">//讀取檔案成 base64格式</span></span><br><span class=\"line\">      $(<span class=\"string\">'#bahaimgur'</span>).hide(),</span><br><span class=\"line\">        $(<span class=\"string\">'#bhImgMsg'</span>)</span><br><span class=\"line\">          .html(<span class=\"string\">'圖片上傳中, 請稍候...'</span>)</span><br><span class=\"line\">          .show(),</span><br><span class=\"line\">        $(<span class=\"string\">'#bhImgModeUpload'</span>).hide()</span><br><span class=\"line\">      <span class=\"keyword\">return</span> upload(image.split(<span class=\"string\">'base64,'</span>)[<span class=\"number\">1</span>]) <span class=\"comment\">//這邊要做split是因為readbase64給的字串是dataurl的形式，可是imgur api要的是純base64字串</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    .then(<span class=\"function\"><span class=\"params\">r</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!r.success) &#123;</span><br><span class=\"line\">        alert(<span class=\"string\">'上傳失敗'</span>)</span><br><span class=\"line\">        egg.lightbox.close()</span><br><span class=\"line\">        <span class=\"keyword\">return</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"comment\">//r.data.link 是照片的網址</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (unsafeWindow.bahaRte != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//如果有所見即所得編輯器</span></span><br><span class=\"line\">        bahaRte.toolbar.insertUploadedImage(r.data.link)</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ($(<span class=\"string\">'#balaTextId'</span>).length) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//如果是公會/叭啦叭啦頁面的回覆框旁邊的上傳圖片</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> id = $(<span class=\"string\">'#balaTextId'</span>).html() <span class=\"comment\">//取得輸入框的id</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> $tx = $(<span class=\"string\">'#'</span> + id) <span class=\"comment\">//輸入框</span></span><br><span class=\"line\">        $tx.val($tx.val() + r.data.link) <span class=\"comment\">//append</span></span><br><span class=\"line\">        egg.lightbox.close()</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ($(<span class=\"string\">'#msgtalk'</span>).length) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//如果是公會/叭啦叭啦頁面的新增欄位 (這一定要放在上面的if後面)</span></span><br><span class=\"line\">        egg.lightbox.close()</span><br><span class=\"line\">        <span class=\"keyword\">const</span> $msgtalk = $(<span class=\"string\">'#msgtalk'</span>)</span><br><span class=\"line\">        $msgtalk.val($msgtalk.val() + r.data.link) <span class=\"comment\">//append</span></span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//其他種類 ex:新版哈拉區文章底部的簡易編輯器</span></span><br><span class=\"line\">        prompt(<span class=\"string\">'暫時還不支援這種編輯器，不過可以複製下方的網址來貼上'</span>, r.data.link)</span><br><span class=\"line\">        $(<span class=\"string\">'#bhImgMsg'</span>).hide()</span><br><span class=\"line\">        $(<span class=\"string\">'#bhImgModeUpload'</span>).show()</span><br><span class=\"line\">        $(<span class=\"string\">'#bahaimgur'</span>).show()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"bahaimgur-cvt\"><a href=\"#bahaimgur-cvt\" class=\"headerlink\" title=\"#bahaimgur_cvt\"></a>#bahaimgur_cvt</h3><p>這和上面的也有點類似，不過更簡單一些</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($(<span class=\"string\">'#bahaimgur_cvt'</span>).length) <span class=\"keyword\">return</span></span><br><span class=\"line\">$(<span class=\"string\">'#bhImgImageUrl'</span>).after(<span class=\"string\">`&lt;button id=\"bahaimgur_cvt\"&gt;轉換成imgur網址&lt;/button&gt;`</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">$(<span class=\"string\">'#bahaimgur_cvt'</span>).on(<span class=\"string\">'click'</span>, e =&gt; &#123;</span><br><span class=\"line\">  e.preventDefault()</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!chk_isAuthorized()) &#123;</span><br><span class=\"line\">    login()</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> url = $(<span class=\"string\">'#bhImgImageUrl'</span>).val() <span class=\"comment\">//取得輸入框內容</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!url) &#123;</span><br><span class=\"line\">    alert(<span class=\"string\">'請輸入網址'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  $(<span class=\"string\">'#bhImgMsg'</span>)</span><br><span class=\"line\">    .html(<span class=\"string\">'圖片上傳中, 請稍候...'</span>)</span><br><span class=\"line\">    .show()</span><br><span class=\"line\">  upload(url).then(<span class=\"function\"><span class=\"params\">r</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//直接把原本的 url 作為 image 傳給 imgur api</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!r.success) &#123;</span><br><span class=\"line\">      alert(<span class=\"string\">'上傳失敗'</span>)</span><br><span class=\"line\">      egg.lightbox.close()</span><br><span class=\"line\">      <span class=\"keyword\">return</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $(<span class=\"string\">'#bhImgImageUrl'</span>).val(r.data.link) <span class=\"comment\">//把原本的輸入框網址換成 imgur 回傳的 url</span></span><br><span class=\"line\">    $(<span class=\"string\">'#bhImgMsg'</span>).hide()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>","categories":[{"name":"userscript","path":"api/categories/userscript.json"}],"tags":[{"name":"javascript","path":"api/tags/javascript.json"},{"name":"userscript","path":"api/tags/userscript.json"},{"name":"Bahamut","path":"api/tags/Bahamut.json"}]}